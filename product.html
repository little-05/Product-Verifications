<!DOCTYPE html>
<html>
<head>
  <title>Product Verification</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      background: #f8f8f8;
    }
    .card {
      background: #fff;
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
    }
    .title {
      font-size: 22px;
      font-weight: bold;
    }
    .error {
      color: red;
      font-size: 18px;
    }
  </style>
</head>
<body>

<h2 class="title">Product Verification</h2>
<div id="result">Loading....</div>

<script>
  // Read ID from QR URL
  const urlParams = new URLSearchParams(window.location.search);
  const productID = urlParams.get("id");

  if (!productID) {
    document.getElementById("result").innerHTML =
      '<p class="error">Missing Product ID in URL. Format → product.html?id=PRD001</p>';
  }

  // ------------------------------
  // MAIN GOOGLE SHEET CSV LINK
  // ------------------------------
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8Wv2XV--hyJK1ny3D5NiII-3vtotKAnbgmQ9ZoDxQto8r-PCWLM49hGM4dOip8tOupf_ue57GszdB/pub?gid=0&single=true&output=csv"; 
  // IMPORTANT: This must be *CSV Export* link

  // ------------------------------
  // FALLBACK JSON FILE
  // ------------------------------
  const JSON_FALLBACK = "products.json";

  async function loadProducts() {
    // FIRST TRY GOOGLE SHEET
    try {
      console.log("Trying Google Sheet CSV...");

      const res = await fetch(CSV_URL);
      if (!res.ok) throw new Error("Google Sheet not reachable");

      const csv = await res.text();
      const rows = csv.trim().split("\n").map(r => r.split(","));
      const headers = rows[0];

      const data = rows.slice(1).map(row => {
        let obj = {};
        headers.forEach((h, i) => {
          obj[h.trim()] = row[i] ? row[i].trim() : "";
        });
        return obj;
      });

      console.log("Loaded from Google Sheet");
      return data;

    } catch (err) {
      console.warn("Google Sheet FAILED → Using fallback JSON...");

      // NOW TRY JSON FILE
      try {
        const res = await fetch(JSON_FALLBACK);
        if (!res.ok) throw new Error("JSON not found");

        const json = await res.json();
        console.log("Loaded from products.json");
        return json;

      } catch (err2) {
        document.getElementById("result").innerHTML =
          '<p class="error">Error: Unable to load product database.</p>';

        return [];
      }
    }
  }

  // After data loads...
  loadProducts().then(products => {

    // SUPPORT BOTH COLUMN TYPES:
    // Sheet might use ProductID, JSON might use id
    const product = products.find(p =>
      p.ProductID === productID || p.id === productID
    );

    if (!product) {
      document.getElementById("result").innerHTML =
        '<p class="error">❌ Invalid Product — No matching data found.</p>';
      return;
    }

    // Support both formats
    const pid   = product.ProductID || product.id;
    const name  = product.ProductName || product.name;
    const desc  = product.Description || product.description;
    const status = product.Status || (product.valid ? "Valid" : "Invalid");

    document.getElementById("result").innerHTML = '
      <div class="card">
        <p><strong>Product ID:</strong> ${pid}</p>
        <p><strong>Name:</strong> ${name}</p>
        <p><strong>Description:</strong> ${desc}</p>
        <p><strong>Status:</strong> ${status}</p>
      </div>
    ';
  });
</script>

</body>
</html>
